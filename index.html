<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Conveniencia Machine</title>
<style>
  body {
    font-family: Arial;
    margin: 0;
    padding: 0;
    background: url('fundo.png') no-repeat center center fixed;
    background-size: cover;
    overflow-x: hidden;
  }

  h1 {
    text-align: center;
    color: #fff;
    text-shadow: 1px 1px 5px rgba(0,0,0,0.7);
    margin-top: 20px;
  }

  /* Carrossel de produtos */
  #produtos {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    padding: 50px 25vw; /* adiciona espa√ßo nas laterais para centralizar 1¬∫ e √∫ltimo */
    gap: 40px;
    justify-content: flex-start;
    scrollbar-width: none;
  }
  #produtos::-webkit-scrollbar { display: none; }

  .produto {
    flex: 0 0 250px;
    height: 380px;
    scroll-snap-align: center;
    border-radius: 20px;
    background: rgba(255,255,255,0.95);
    box-shadow: 0 6px 10px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    transition: transform 0.3s, opacity 0.3s;
    padding: 20px;
    box-sizing: border-box;
  }

  .produto img {
    width: 180px;
    height: 180px;
    object-fit: contain;
    display: block;
    margin: 0 auto;
  }

  .produto button {
    padding: 5px 10px;
    margin: 2px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
    background-color: #007bff;
    color: #fff;
  }

  .produto button:hover {
    background-color: #0056b3;
  }

  /* Destaque central */
  .produto.central {
    transform: scale(1.15);
    opacity: 1;
    z-index: 10;
  }

  .produto:not(.central) {
    transform: scale(0.85);
    opacity: 0.6;
    z-index: 1;
  }

  /* Carrinho */
  .carrinho {
    position: fixed;
    bottom: 20px;
    right: 20px;
    border: 2px solid #000;
    padding: 10px;
    background: rgba(255,255,255,0.9);
    border-radius: 10px;
    width: 220px;
    height: 220px;
    text-align: center;
    z-index: 100;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .carrinho img {
    width: 45px;
    height: 45px;
    margin: 0 auto 5px auto;
  }

  #itensCarrinho {
    flex-grow: 1;
    overflow-y: auto;
    font-size: 14px;
    margin-bottom: 5px;
  }

  .carrinho button {
    padding: 5px 8px;
    font-size: 12px;
  }

</style>
</head>
<body>
<h1>Cat√°logo de Teste</h1>
<div id="produtos"></div>

<div class="carrinho">
  <img src="carrinho.png" alt="Carrinho">
  <div id="itensCarrinho">Vazio</div>
  <div>Total: R$ <span id="total">0.00</span></div>
  <button onclick="confirmarPedido()">Confirmar Pedido</button>
  <button onclick="cancelarPedido()">Cancelar Pedido</button>
</div>

<script>
const produtos = [
  {id:1, nome:"Brahma", preco:4.00, estoque:30, img:"produto_1.png"},
  {id:2, nome:"Skol", preco:5.00, estoque:30, img:"produto_2.png"},
  {id:3, nome:"Coca-Cola", preco:4.00, estoque:20, img:"produto_3.png"},
  {id:4, nome:"Coca-Cola zero", preco:5.00, estoque:15, img:"produto_4.png"},
  {id:5, nome:"Sprite", preco:5.00, estoque:16, img:"produto_5.png"},
  {id:6, nome:"Energ√©tico", preco:10.00, estoque:18, img:"produto_6.png"},
  {id:7, nome:"√Ågua sem g√°s", preco:3.00, estoque:23, img:"produto_7.png"},
  {id:8, nome:"Original", preco:6.00, estoque:14, img:"produto_8.png"}
];

let carrinho = {};

function mostrarProdutos() {
  const div = document.getElementById('produtos');
  div.innerHTML = '';
  produtos.forEach(p => {
    const prodDiv = document.createElement('div');
    prodDiv.className = 'produto';
    prodDiv.innerHTML = `
      <img src="${p.img}" alt="${p.nome}">
      <div style="text-align:center">
        <b>${p.nome}</b><br>
        R$ ${p.preco.toFixed(2)}<br>
        Estoque: ${p.estoque}
      </div>
      <div>
        <button onclick="alterarQuantidade(${p.id}, -1)">-</button>
        <span id="qtd-${p.id}">0</span>
        <button onclick="alterarQuantidade(${p.id}, 1)">+</button>
      </div>
    `;
    div.appendChild(prodDiv);
  });

  destacarCentral();
}

// Atualiza carrinho
function alterarQuantidade(id, delta) {
  if (!carrinho[id]) carrinho[id] = 0;
  const produto = produtos.find(p => p.id === id);
  let novaQtd = carrinho[id] + delta;
  if (novaQtd < 0) novaQtd = 0;
  if (novaQtd > produto.estoque) novaQtd = produto.estoque;
  carrinho[id] = novaQtd;
  document.getElementById(`qtd-${id}`).innerText = novaQtd;
  atualizarCarrinho();
}

function atualizarCarrinho() {
  const div = document.getElementById('itensCarrinho');
  div.innerHTML = '';
  let total = 0;
  let vazio = true;
  for (let id in carrinho) {
    if (carrinho[id] > 0) {
      vazio = false;
      const p = produtos.find(prod => prod.id == id);
      total += p.preco * carrinho[id];
      div.innerHTML += `${p.nome} x ${carrinho[id]} = R$ ${(p.preco * carrinho[id]).toFixed(2)}<br>`;
    }
  }
  if (vazio) div.innerHTML = 'Vazio';
  document.getElementById('total').innerText = total.toFixed(2);
}

function cancelarPedido() {
  carrinho = {};
  mostrarProdutos();
  atualizarCarrinho();
}

// Destaca produto central no carrossel
function destacarCentral() {
  const container = document.getElementById('produtos');
  const produtosDivs = container.querySelectorAll('.produto');

  function atualizarCentral() {
    const meio = container.scrollLeft + container.offsetWidth / 2;
    produtosDivs.forEach(p => {
      const pCentro = p.offsetLeft + p.offsetWidth / 2;
      if (Math.abs(meio - pCentro) < p.offsetWidth / 2) {
        p.classList.add('central');
      } else {
        p.classList.remove('central');
      }
    });
  }

  container.addEventListener('scroll', atualizarCentral);
  atualizarCentral(); // inicial
}

function confirmarPedido() {
  if (Object.values(carrinho).every(q => q === 0)) {
    alert("Carrinho vazio!");
    return;
  }

  const divCarrinho = document.getElementById('itensCarrinho');
  divCarrinho.innerHTML = "Aguardando pagamento na maquininha... ‚è≥";

  const promessas = [];
  const ipESP32 = "192.168.5.57"; // <--- substitua pelo IP real do seu ESP32

  for (let id in carrinho) {
    const quantidade = carrinho[id];
    if (quantidade > 0) {
      const produto = produtos.find(p => p.id == id).nome;
      for (let i = 0; i < quantidade; i++) {
        const url = `http://${ipESP32}/pagar?produto=${encodeURIComponent(produto)}`;
        promessas.push(
          fetch(url)
            .then(resp => resp.json())
            .then(data => console.log('ESP32 respondeu:', data))
            .catch(err => console.error('Erro no ESP32:', err))
        );
      }
    }
  }

  Promise.all(promessas).then(() => {
    divCarrinho.innerHTML = "Pedido enviado! Aguardando libera√ß√£o do produto... üéâ";
    cancelarPedido();
  }).catch(() => {
    divCarrinho.innerHTML = "Erro ao enviar pedido para a m√°quina!";
  });
}

mostrarProdutos();
</script>
</body>
</html>
